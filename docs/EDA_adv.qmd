---
title: "EDA II"
editor_options: 
  chunk_output_type: console
---

# 데이터

```{r}
library(tidyverse)
library(readxl)

law_raw <- read_excel("data/(230410)최종결과표(통합본).xlsx", skip = 0)

law_tbl <- law_raw |>
  janitor::clean_names(ascii = FALSE) |> 
  mutate(사무_판단 = ifelse(is.na(사무_판단), 0, 사무_판단)) |> 
  mutate(사무유형 = str_remove(사무유형, "\r\n")) |>
  # 사무유형: 국가, 시도, 공동, ...
  mutate(사무유형 = case_when(사무유형 == "국가시도" ~ "국가-시도",
                              사무유형 == "정부" ~ "국가",
                              사무유형 == "공동" ~ "국가-시도",
                              is.na(사무유형) ~ "없음",
                              TRUE ~ 사무유형))  

```  


# EDA

## 법령명 행수

```{r}
library(gt)

law_tbl |> 
  count(법령명, sort = TRUE, name = "행수") |> 
  slice_max(행수, n = 10) |> 
  gt()
```

## 사무판단 건수

```{r}
law_tbl |> 
  mutate(사무_판단 = ifelse(is.na(사무_판단), 0, 사무_판단)) |>
  # filter(is.na(사무_판단)) |> 
  count(사무_판단, sort = TRUE, name = "건수") |> 
  mutate(비율 = 건수 / sum(건수)) |> 
  janitor::adorn_totals(name = "합계") |> 
  gt() |> 
  cols_align("center") |> 
  fmt_integer(건수) |> 
  fmt_percent(비율, decimals = 1)
```


## 사무판단 건수와 행수

:::{.panel-tabset}

### 표 {.unnumbered}


```{r}
library(gt)
law_tbl |> 
  group_by(법령명) |> 
  summarise(사무건수 = sum(사무_판단),
            행수 = n()) |> 
  slice_max(사무건수, n = 10) |>
  gt::gt() |> 
  cols_align("center") 
  
```

### 그래프 {.unnumbered}

```{r}

law_tbl |> 
  group_by(법령명) |> 
  summarise(사무건수 = sum(사무_판단),
            행수 = n()) |> 
  arrange(사무건수) |> 
  ggplot(aes(x = 행수, y = 사무건수)) +
    geom_point() 
```

:::


## 행수분포와 사무판단

```{r}
law_tbl |> 
  group_by(법령명) |> 
  summarise(사무건수 = sum(사무_판단),
            행수 = n()) |> 
  mutate(사무판단 = ifelse(사무건수 == 0, "사무없음", "사무있음")) |> 
  ggplot(aes(x = 행수, fill = 사무판단)) +
    geom_density(alpha = 0.7) +
    theme(legend.position = "bottom") +
    scale_x_sqrt() 
```

## 수행주체

### 조문 기준

```{r}
library(gtExtras)

law_tbl |>
  mutate(중앙지자체 = case_when(사무유형 %in% c("국가") ~ "중앙정부",
                                사무유형 %in% c("시도", "시도-시군구", "시군구") ~ "지자체",
                                TRUE ~ "공동")) |>
  filter(사무유형 != "없음") |> 
  count(중앙지자체, 사무유형, name = "건수") |>
  mutate(비율 = 건수 / sum(건수)) |> 
  gt(groupname_col = "중앙지자체",
     rowname_col   = "사무유형"  ) |> 
  fmt_percent(비율, decimals = 1) |>
  fmt_integer(건수) |>
  grand_summary_rows(
    fns = list(
      "합계" = ~sum(.)),
    columns = c("건수"),
    formatter = fmt_integer
  ) |> 
  grand_summary_rows(
    fns = list(
      "합계" = ~sum(.)),
    columns = c("비율"),
    formatter = fmt_percent,
    decimals = 0
  ) |> 
  gt_theme_538()
```

### 법령 기준

:::{.panel-tabset}

#### 표 {.unnumbered}


```{r}
law_tbl |>
  mutate(중앙지자체 = case_when(사무유형 %in% c("국가") ~ "중앙정부",
                                사무유형 %in% c("시도", "시도-시군구", "시군구") ~ "지자체",
                                사무유형 == "없음" ~ "없음",
                                TRUE ~ "공동")) |>  
  # filter(사무유형 != "없음") |>
  group_by(법령명) |>
  count(중앙지자체, 사무유형) |> 
  ungroup() |> 
  count(중앙지자체, 사무유형, name = "법령건수", sort = TRUE) |> 
mutate(비율 = 법령건수 / sum(법령건수)) |> 
  gt(groupname_col = "중앙지자체",
     rowname_col   = "사무유형"  ) |> 
  fmt_percent(비율, decimals = 1) |>
  fmt_integer(법령건수) |>
  grand_summary_rows(
    fns = list(
      "합계" = ~sum(.)),
    columns = c("법령건수"),
    formatter = fmt_integer
  ) |> 
  grand_summary_rows(
    fns = list(
      "합계" = ~sum(.)),
    columns = c("비율"),
    formatter = fmt_percent,
    decimals = 0
  ) |> 
  gt_theme_538()  
```

#### 그래프 {.unnumbered}

[Venn diagram with ggVennDiagram](https://r-charts.com/part-whole/ggvenndiagram/)

```{r}
library(ggVennDiagram)


affairs_type <- law_tbl |>
  filter(사무유형 != "없음") |>
  group_by(법령명) |>
  count(사무유형) |>
  arrange(법령명, 사무유형) |>
  ungroup() |>
  separate(사무유형, into = c("사무1", "사무2", "사무3"), sep = "-") |>
  mutate(번호 = row_number()) |> 
  mutate(사무1 = str_glue("{사무1}_{번호}"),
         사무2 = str_glue("{사무2}_{번호}"),
         사무3 = str_glue("{사무3}_{번호}")) |> 
  select(-법령명, -n, -번호) |> 
  pivot_longer(사무1:사무3, names_to = "사무구분", values_to = "사무") |> 
  filter(!str_detect(사무, "^NA")) |> 
  mutate(집합 = case_when(str_detect(사무, "국가") ~ "국가",
                          str_detect(사무, "시도") ~ "시도",
                          str_detect(사무, "시군구") ~ "시군구",
                          TRUE ~ "기타")) |> 
  mutate(원소 = str_extract(사무, "\\d{1,5}"))

    
korea_type <- affairs_type |> 
  filter(집합 == "국가") |> 
  pull(원소) |> 
  unlist()

sido_type <- affairs_type |> 
  filter(집합 == "시도") |> 
  pull(원소) |> 
  unlist()

sgg_type <- affairs_type |> 
  filter(집합 == "시군구") |> 
  pull(원소) |> 
  unlist()

ggVennDiagram(list(국가 = korea_type, 시도 = sido_type, 시군구 = sgg_type),
              category.names = c("국가",
                                 "시도",
                                 "구시군"),
               label_alpha = 0,
               color = 1, lwd = 0.7) +
  scale_fill_gradient(low = "#F4FAFE", high = "#4981BF") +
  theme(legend.position = "none")

```

:::

### 국가사무 유형


```{r}
law_tbl |>
  filter(사무유형 != "없음") |>
  group_by(법령명) |>
  count(사무유형) |>
  arrange(법령명, 사무유형) |> 
  summarise(사무패턴 = str_c(사무유형, collapse = "; ")) |> 
  count(사무패턴, name = "법령건수", sort = TRUE) |> 
  gt() |> 
  fmt_integer(법령건수) |> 
  grand_summary_rows(
    fns = list(
      "합계" = ~sum(.)),
    columns = c("법령건수"),
    formatter = fmt_integer
  ) |> 
  gt_theme_538()
  
```







